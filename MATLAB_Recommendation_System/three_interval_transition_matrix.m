clear;
%transition count matrix 
One_cycle_tran = [197, 88, 12;
                        0, 72, 22;
                        0, 0, 0];
Two_cycle_tran = [3, 1, 0;
                        0, 1, 2;
                        0, 0, 0];
Three_cycle_tran = [18, 0, 0;
                        0, 1, 3;
                        0, 0, 0];
                    
%Initial M0
M0 = [0.4 0.3 0.3;
    0 0.5 0.5;
    0 0 1];
MM0 = M0^2;
MMM0 = M0^3;


%EM iteration
max_iter = 10000;
iter = 0;
is_done = false;
while ~is_done
    iter = iter+1
    n = zeros(2,3);
    %E-step
    n(1,1) = One_cycle_tran(1,1)+... 
             2*Two_cycle_tran(1,1)*(M0(1,1)^2)/(MM0(1,1))+...
             Two_cycle_tran(1,2)*(M0(1,1)*M0(1,2)/(MM0(1,2)))+...
             Two_cycle_tran(1,3)*(M0(1,1)*M0(1,3)/(MM0(1,3)))+...
             3*Three_cycle_tran(1,1)+... 
             2*Three_cycle_tran(1,2)*(M0(1,1)*M0(1,1)*M0(1,2)/MMM0(1,2))+...
             Three_cycle_tran(1,2)*(M0(1,1)*M0(1,2)*M0(2,2)/MMM0(1,2))+...
             2*Three_cycle_tran(1,3)*(M0(1,1)*M0(1,1)*M0(1,3)/MMM0(1,3))+...
             Three_cycle_tran(1,3)*((M0(1,1)*M0(1,2)*M0(2,3)+M0(1,1)*M0(1,3)*M0(3,3))/MMM0(1,3));
    n(1,2) = One_cycle_tran(1,2)+...
             Two_cycle_tran(1,2)+...
             Two_cycle_tran(1,3)*(M0(1,2)*M0(2,3)/(MM0(1,3)))+...
             Three_cycle_tran(1,2)+...
             Three_cycle_tran(1,3)*((M0(1,1)*M0(1,2)*M0(2,3)+M0(1,2)*M0(2,2)*M0(2,3))/MMM0(1,3));
    n(1,3) = One_cycle_tran(1,3)+... 
             Two_cycle_tran(1,3)*((M0(1,1)*M0(1,3)+M0(1,3))/(MM0(1,3)))+...
             Three_cycle_tran(1,3)*((M0(1,1)*M0(1,1)*M0(1,3)+M0(1,1)*M0(1,3)*M0(3,3)+M0(1,3)*M0(3,3)*M0(3,3))/MMM0(1,3));          
    n(2,2) = One_cycle_tran(2,2)+... 
             Two_cycle_tran(1,2)*(M0(1,2)*M0(2,2)/(MM0(1,2)))+...
             Two_cycle_tran(2,3)*(M0(2,2)*M0(2,3)/(MM0(2,3)))+...
             2*Two_cycle_tran(2,2)*(M0(2,2)*M0(2,2)/(MM0(2,2)))+...
             3*Three_cycle_tran(2,2)+... 
             2*Three_cycle_tran(1,2)*(M0(1,2)*M0(2,2)*M0(2,2)/MMM0(1,2))+...
             Three_cycle_tran(1,2)*(M0(1,1)*M0(1,2)*M0(2,2)/MMM0(1,2))+...
             2*Three_cycle_tran(2,3)*(M0(2,2)*M0(2,2)*M0(2,3)/MMM0(2,3))+...
             Three_cycle_tran(1,3)*((M0(1,2)*M0(2,2)*M0(2,3))/MMM0(1,3))+...
             Three_cycle_tran(2,3)*((M0(2,2)*M0(2,3)*M0(3,3))/MMM0(2,3));
    n(2,3) = One_cycle_tran(2,3)+... 
             Two_cycle_tran(2,3)*((M0(2,2)*M0(2,3)+...
             M0(2,3))/(MM0(2,3)))+...
             Two_cycle_tran(1,3)*(M0(1,2)*M0(2,3)/(MM0(1,3)))+...
             Three_cycle_tran(2,3)+...
             Three_cycle_tran(1,3)*((M0(1,2)*M0(2,3)*M0(3,3)+M0(1,1)*M0(1,2)*M0(2,3)+M0(1,2)*M0(2,2)*M0(2,3))/MMM0(1,3));
    %M-step    
    for ii = 1:2
        for jj = 1:3
            M0(ii,jj) = n(ii,jj)/sum(n(ii,:));
        end
    end
    if iter == max_iter
        is_done = true;
    end
    
    M0
end


M0